<!DOCTYPE html>
<html lang="en">
	<head>
  		<title>Rhymer</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<style>
			div.scrollBox {
				width: 500px;
				height: 300px;
		  		overflow: auto;
  				border: 1px solid black;
 				padding: 1%;
			}
			.match {
  				color: red;
			}
		</style>
	</head>
	<body>
		
		<input id="searchField">
		<button id="searchButton" onclick="generateRandom()">Search</button>
		
		<p></p>
		
		<div class = "scrollBox" id="searchResults"></div>
		
		<script>
			var field = document.getElementById("searchField");
			var button = document.getElementById("searchButton");
			var searchResults = document.getElementById("searchResults");
			
			var characters = "qwertyuiopasdfghjklzxcvbnm";
			
			var poem = [];
			
			function accessURL(address, function_of_data){
				var x = new XMLHttpRequest();
		  		x.open("GET", address);
		  		x.onreadystatechange = function(){
		    		if(x.readyState == 4 && x.status == 200){
		      			var data = JSON.parse(x.responseText);
		      			function_of_data(data);
		    		}
	  			};
	  			x.send(null);
			}
			
			function generateFollowing(word){
				var address = 'https://cors-anywhere.herokuapp.com/https://api.datamuse.com/words?lc=' + word;
				accessURL(address, function(){
					word = data[0].word;
		      		poem.push(word);
		      		console.log(poem);
		      		generateFollowing(word);
		    	});
			}
		
			function generatePoem(rhyme){
		  		console.log(rhyme);
		  		var order = getRandomOrder(rhyme.length);
		  		getStress(rhyme[0].tags[0]);
			}
		
			function generateRandom(){
		  		var address = 'https://cors-anywhere.herokuapp.com/https://api.datamuse.com/words?sp=' + characters.charAt(Math.floor(Math.random() * characters.length)) + '*&md=sr';
	  			accessURL(address, function(){
		      		var word = data[Math.floor(Math.random() * data.length)];
		      		while(!isIambic(word.tags[0])){
		        		console.log("RETRYING:", word.word);
		    	    	word = data[Math.floor(Math.random() * data.length)];
		    	  	}
		    	  	console.log("RANDOM WORD:", word.word);
		    	  	generateRhyme(word.word);
		  		});
			}
		
			function generateRhyme(word){
		  		var address = 'https://cors-anywhere.herokuapp.com/https://api.datamuse.com/words?rel_rhy=' + word + '&md=r';
				accessURL(address, function(){
		      		console.log("ATTEMPT:", data);
		      		if(data.length > 10 && !(data[9].score === undefined)){
		        		//maybe remove items that don't have a score at all
		        		generatePoem(data);
		      		}
		      		else{
		        		generateRandom();
		      		}
		    	});
		  	}
			
			function getStress(d){
		  		d = d.replace("pron:", "").replace(/[^01]/g, "");
		  		return d.split("");
			}
	
			function isIambic(d){
		  		d = d.replace("pron:", "").replace(/[^01]/g, "");
		  		d = d.split("");
		  		for(var i = 0; i < d.length; i++){
		    		if(d[i] === "1"){
		      			return (d.length - i - 1) % 2 == 0;
		    		}
		  		}
			}
		
			function getRandomOrder(length){
		  		var order = [];
		  		for(var i = 0; i < length; i++){
		    		order.splice(Math.floor(Math.random() * order.length), 0, i);
		  		}
		  		return order;
			}
		</script>
	
	</body>
</html>
